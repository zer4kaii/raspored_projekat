CREATE TABLE PREDMETI(
id_predmeta NUMBER(6) PRIMARY KEY,
naziv_predmeta VARCHAR2(50) NOT NULL,
broj_studenata NUMBER(3) NOT NULL
);

CREATE TABLE PREDMETI_NA_SMERU(
id_s NUMBER(6) NOT NULL,
id_p NUMBER(6) NOT NULL,
tip VARCHAR2(50) NOT NULL,
CONSTRAINT fk1 FOREIGN KEY(id_s)
REFERENCES SMEROVI(id_smera),
CONSTRAINT fk2 FOREIGN KEY(id_p)
REFERENCES PREDMETI(id_predmeta),
CONSTRAINT pk1 PRIMARY KEY(id_s,id_p)
);

CREATE TABLE PREDAVACI(
id_predavaca NUMBER(6) PRIMARY KEY,
ime VARCHAR2(30) NOT NULL,
prezime VARCHAR2(30) NOT NULL,
titula VARCHAR2(30) NOT NULL,
sifra VARCHAR2(6) NOT NULL UNIQUE,
email VARCHAR2(60)
);

CREATE TABLE AKTIVNOSTI(
id_aktivnosti NUMBER(6) PRIMARY KEY,
id_predavaca NUMBER(6) NOT NULL,
id_predmeta NUMBER(6) NOT NULL,
tip_aktivnosti VARCHAR2(60) NOT NULL,
broj_studenata NUMBER(3) NOT NULL,
naziv VARCHAR2(60) NOT NULL,
redovna NUMBER(1) NOT NULL,
trajanje NUMBER(2) NOT NULL,
CONSTRAINT fk5 FOREIGN KEY(id_predavaca)
REFERENCES PREDAVACI(id_predavaca),
CONSTRAINT fk6 FOREIGN KEY(id_predmeta)
REFERENCES PREDMETI(id_predmeta)
);

CREATE TABLE UCIONICE(
broj NUMBER(3) PRIMARY KEY,
naziv VARCHAR2(30) NOT NULL,
kap_k NUMBER(3) NOT NULL,
kap_s NUMBER(3) NOT NULL
);

CREATE TABLE ZAUZETOSTI(
datum DATE NOT NULL,
vreme_od NUMBER(2) NOT NULL,
br_uc NUMBER(3) NOT NULL,
aktivnost NUMBER(6),
CONSTRAINT fk8 FOREIGN KEY(aktivnost)
REFERENCES AKTIVNOSTI(id_aktivnosti),
CONSTRAINT fk9 FOREIGN KEY(br_uc)
REFERENCES UCIONICE(broj),
CONSTRAINT pk4 PRIMARY KEY(datum,vreme_od,br_uc)
);

BEGIN
INSERT INTO SMEROVI VALUES(100001, 'Informacione tehnologije', 535, '01/03/2023');
INSERT INTO SMEROVI VALUES(100002, 'Informacione tehnologije na engleskom jeziku', 15, '05/05/2023');
INSERT INTO SMEROVI VALUES(100003, 'Elektroenergetika', 77, '02/02/2017');
INSERT INTO SMEROVI VALUES(100004, 'Informacione tehnologije u masinstvu', 35, '17/07/2017');
INSERT INTO SMEROVI VALUES(100005, 'Inzenjerski menadzment', 146, '25/03/2014');
INSERT INTO SMEROVI VALUES(100006, 'Mehatronika', 94, '01/03/2023');
INSERT INTO SMEROVI VALUES(100007, 'Racunarsko i softversko inzenjerstvo', 92, '09/02/2017');
COMMIT;
END;

BEGIN
INSERT INTO PREDMETI VALUES(10069, 'Matematika 1', 136);
INSERT INTO PREDMETI VALUES(10060, 'Informacione tehnologije', 120);
INSERT INTO PREDMETI VALUES(10187, 'Uvod u programiranje', 111);
INSERT INTO PREDMETI VALUES(23001, 'Vestine poslovne komunikacije', 93);
INSERT INTO PREDMETI VALUES(11048, 'Engleski jezik 2', 80);
INSERT INTO PREDMETI VALUES(1076, 'Matematika 2', 191);
INSERT INTO PREDMETI VALUES(10144, 'Programski jezici', 60);
INSERT INTO PREDMETI VALUES(10231, 'Osnovi racunarske tehnike', 117);
INSERT INTO PREDMETI VALUES(10002, 'Arhitektura racunara', 56);
INSERT INTO PREDMETI VALUES(10164, 'Racunarske mreze i komunikacije', 122);
INSERT INTO PREDMETI VALUES(10102, 'Osnovi elektrotehnike 1', 89);
INSERT INTO PREDMETI VALUES(10198, 'Fizika 1', 78);
INSERT INTO PREDMETI VALUES(10120, 'Osnovi tehnicke pismenosti', 66);
INSERT INTO PREDMETI VALUES(11012, 'Osnove programiranja', 112);
INSERT INTO PREDMETI VALUES(11015, 'Praktikum iz fizike', 75);
INSERT INTO PREDMETI VALUES(10081, 'Tehnicka mehanika 1', 31);
INSERT INTO PREDMETI VALUES(10183, 'Tehnicki materijali', 27);
INSERT INTO PREDMETI VALUES(11009, 'Konstruktivna geometrija', 13);
INSERT INTO PREDMETI VALUES(11046, 'Informacione tehnologije', 67);
INSERT INTO PREDMETI VALUES(10186, 'Uvod u menadzment', 123);
INSERT INTO PREDMETI VALUES(10188, 'Uvod u tehnicke sisteme', 74);
INSERT INTO PREDMETI VALUES(11001, 'Tehnicka fizika 1', 37);
COMMIT;
END;

BEGIN
INSERT INTO PREDMETI_NA_SMERU VALUES(100001, 10069, 'O');
INSERT INTO PREDMETI_NA_SMERU VALUES(100001, 10060, 'O');
INSERT INTO PREDMETI_NA_SMERU VALUES(100001, 10187, 'O');
INSERT INTO PREDMETI_NA_SMERU VALUES(100001, 23001, 'O');
INSERT INTO PREDMETI_NA_SMERU VALUES(100001, 11048, 'O');
INSERT INTO PREDMETI_NA_SMERU VALUES(100001, 1076, 'O');
INSERT INTO PREDMETI_NA_SMERU VALUES(100001, 10144, 'O');
INSERT INTO PREDMETI_NA_SMERU VALUES(100001, 10231, 'O');
INSERT INTO PREDMETI_NA_SMERU VALUES(100001, 10002, 'O');
INSERT INTO PREDMETI_NA_SMERU VALUES(100001, 10164, 'O');
INSERT INTO PREDMETI_NA_SMERU VALUES(100003, 10069, 'O');
INSERT INTO PREDMETI_NA_SMERU VALUES(100003, 10102, 'O');
INSERT INTO PREDMETI_NA_SMERU VALUES(100003, 10198, 'O');
INSERT INTO PREDMETI_NA_SMERU VALUES(100003, 10120, 'O');
INSERT INTO PREDMETI_NA_SMERU VALUES(100003, 11012, 'O');
INSERT INTO PREDMETI_NA_SMERU VALUES(100003, 11015, 'I');
INSERT INTO PREDMETI_NA_SMERU VALUES(100004, 10069, 'O');
INSERT INTO PREDMETI_NA_SMERU VALUES(100004, 10081, 'O');
INSERT INTO PREDMETI_NA_SMERU VALUES(100004, 10183, 'O');
INSERT INTO PREDMETI_NA_SMERU VALUES(100004, 10187, 'O');
INSERT INTO PREDMETI_NA_SMERU VALUES(100004, 11009, 'I');
INSERT INTO PREDMETI_NA_SMERU VALUES(100005, 10069, 'O');
INSERT INTO PREDMETI_NA_SMERU VALUES(100005, 11046, 'O');
INSERT INTO PREDMETI_NA_SMERU VALUES(100005, 10186, 'O');
INSERT INTO PREDMETI_NA_SMERU VALUES(100005, 10188, 'O');
INSERT INTO PREDMETI_NA_SMERU VALUES(100006, 10069, 'O');
INSERT INTO PREDMETI_NA_SMERU VALUES(100006, 10102, 'O');
INSERT INTO PREDMETI_NA_SMERU VALUES(100006, 11001, 'O');
INSERT INTO PREDMETI_NA_SMERU VALUES(100006, 10183, 'O');
INSERT INTO PREDMETI_NA_SMERU VALUES(100006, 11009, 'I');
INSERT INTO PREDMETI_NA_SMERU VALUES(100007, 10069, 'O');
INSERT INTO PREDMETI_NA_SMERU VALUES(100007, 10102, 'O');
INSERT INTO PREDMETI_NA_SMERU VALUES(100007, 10198, 'O');
INSERT INTO PREDMETI_NA_SMERU VALUES(100007, 11012, 'O');
INSERT INTO PREDMETI_NA_SMERU VALUES(100007, 11015, 'I');
COMMIT;
END;

BEGIN
INSERT INTO PREDAVACI VALUES(100001, 'Dragan', 'Djurcic','profesor','xyz321','dragangjurcic@gmail.com');
INSERT INTO PREDAVACI VALUES(100002, 'Aleksandra', 'Kalezic','profesor','alex12','');
INSERT INTO PREDAVACI VALUES(100003, 'Nebojsa', 'Stankovic','profesor','dzek32','nebojsastankovic@gmail.com');
INSERT INTO PREDAVACI VALUES(100004, 'Katarina', 'Karic','asistent','kk095','katarinakaric@gmail.com');
INSERT INTO PREDAVACI VALUES(100005, 'Jelena', 'Plasic','asistent','jp932','plasicjelena@gmail.com');
INSERT INTO PREDAVACI VALUES(100006, 'Marko', 'Markovic','student demonstrator','stud31','markomarkovic@gmail.com');
COMMIT;
END;

BEGIN
INSERT INTO AKTIVNOSTI VALUES(100001, 100001 , 10069,'konsultacije',30,'Konsultacije pred prvi kolokvijum',0,1);
INSERT INTO AKTIVNOSTI VALUES(100002, 100001 , 10069,'nadoknada',80 ,'Nadoknada predavanja iz matematike 1',0,3);
INSERT INTO AKTIVNOSTI VALUES(100003, 100001 , 10069,'kolokvijum', 140 ,'Prvi kolokvijum iz matematike 1',0,2);
INSERT INTO AKTIVNOSTI VALUES(100004, 100004 , 10187,'kolokvijum', 90 ,'Popravni drugi kolokvijum',0,2);
INSERT INTO AKTIVNOSTI VALUES(100005, 100005 , 10144, 'konsultacije',30 ,'Konsultacije u vezi projekta',0,1);
INSERT INTO AKTIVNOSTI VALUES(100006, 100001 , 10069, 'predavanje' ,150,'Predavanje 7: Odredjeni integral',1,3);
INSERT INTO AKTIVNOSTI VALUES(100007, 100001 , 10069, 'vezbe',150 ,'Vezbe 6: Neodredjeni integral',1,3);
INSERT INTO AKTIVNOSTI VALUES(100008, 100003 , 10060, 'predavanje',120 ,'Predavanje 1: Uvod u Informacione tehnologije',1,2);
INSERT INTO AKTIVNOSTI VALUES(100009, 100003 , 10060, 'vezbe',90 ,'Vezbe 3: Kreiranje tabela u Excel-u',1,2);
INSERT INTO AKTIVNOSTI VALUES(100010, 100004 , 10187, 'vezbe',80 ,'Vezbe 2: Algoritmi',1,2);
COMMIT;
END;

BEGIN
INSERT INTO UCIONICE VALUES(212, 'racunarska ucionica' , 16, 32);
INSERT INTO UCIONICE VALUES(214, 'racunarska ucionica' , 20, 35);
INSERT INTO UCIONICE VALUES(21, 'amfiteatar', 100, 366);
INSERT INTO UCIONICE VALUES(215, 'ucionica' , 30, 60);
INSERT INTO UCIONICE VALUES(218, 'racunarska ucionica' , 15, 30);
COMMIT;
END;

BEGIN
INSERT INTO ZAUZETOSTI(datum,vreme_od,br_uc,aktivnost) VALUES('24/04/2024', 10 , 21, 100001);
INSERT INTO ZAUZETOSTI(datum,vreme_od,br_uc,aktivnost) VALUES('25/04/2024', 12 , 21, 100002);
INSERT INTO ZAUZETOSTI(datum,vreme_od,br_uc,aktivnost) VALUES('26/04/2024', 14 , 212,100003);
INSERT INTO ZAUZETOSTI(datum,vreme_od,br_uc,aktivnost) VALUES('24/04/2024', 8 , 214, 100006);
INSERT INTO ZAUZETOSTI(datum,vreme_od,br_uc,aktivnost) VALUES('25/04/2024', 12 , 218, 100007);
INSERT INTO ZAUZETOSTI(datum,vreme_od,br_uc,aktivnost) VALUES('26/04/2024', 14 , 21,100008);
COMMIT;
END;

ALTER TABLE ZAUZETOSTI 
ADD naziv_ucionice VARCHAR2(60);

CREATE OR REPLACE TRIGGER ZAUZETOSTI_NAZIV_UC_UPD_1
BEFORE UPDATE OF naziv_ucionice ON ZAUZETOSTI 
FOR EACH ROW
DECLARE
pragma AUTONOMOUS_TRANSACTION;
BEGIN
 RAISE_APPLICATION_ERROR(
 NUM => -20002,
 MSG => 'ZABRANJENO JE MENJANJE NAZIVA U?IONICE!');
END;

CREATE OR REPLACE TRIGGER ZAUZETOSTI_INS_UPD_1
BEFORE INSERT OR UPDATE ON ZAUZETOSTI
FOR EACH ROW
DECLARE
v_naziv VARCHAR2(50);
BEGIN
 SELECT naziv INTO v_naziv
 FROM UCIONICE
 WHERE broj = :NEW.br_uc;
 :NEW.naziv_ucionice := v_naziv;
END;

CREATE OR REPLACE TRIGGER UCIONICA_NAZIV_UPD
AFTER UPDATE OF naziv ON UCIONICE
FOR EACH ROW
DECLARE
pragma AUTONOMOUS_TRANSACTION;
BEGIN
 EXECUTE IMMEDIATE 'ALTER TRIGGER ZAUZETOSTI_NAZIV_UC_UPD_1 DISABLE';
 EXECUTE IMMEDIATE 'ALTER TRIGGER ZAUZETOSTI_INS_UPD_1 DISABLE';
 UPDATE ZAUZETOSTI
 SET naziv_ucionice = :NEW.naziv
 WHERE br_uc = :NEW.broj;
EXECUTE IMMEDIATE 'ALTER TRIGGER ZAUZETOSTI_NAZIV_UC_UPD_1 ENABLE';
 EXECUTE IMMEDIATE 'ALTER TRIGGER ZAUZETOSTI_INS_UPD_1 ENABLE';
END;

ALTER TABLE AKTIVNOSTI 
ADD ime_predavaca VARCHAR2(50);

CREATE OR REPLACE TRIGGER AKTIVNOSTI_IME_PREDAVACA_UPDATE
BEFORE UPDATE OF ime_predavaca ON AKTIVNOSTI
FOR EACH ROW
BEGIN
    RAISE_APPLICATION_ERROR(
        NUM=>-20002,
        MSG=>'Zabranjeno je direktno menjanje imena predavaca!'
    );
END;

CREATE OR REPLACE TRIGGER AKTIVNOSTI_INSERT_UPDATE
BEFORE INSERT OR UPDATE ON AKTIVNOSTI
FOR EACH ROW
DECLARE
    var_ime_predav VARCHAR2(50);
BEGIN
    SELECT ime INTO var_ime_predav
    FROM PREDAVACI
    WHERE id_predavaca = :NEW.id_predavaca;
    :NEW.ime_predavaca := var_ime_predav;
END;

CREATE OR REPLACE TRIGGER PREDAVACI_IME_UPD
AFTER UPDATE OF ime ON PREDAVACI
FOR EACH ROW
DECLARE
    PRAGMA AUTONOMOUS_TRANSACTION;
BEGIN
    EXECUTE IMMEDIATE 'ALTER TRIGGER AKTIVNOSTI_INSERT_UPDATE DISABLE';
    EXECUTE IMMEDIATE 'ALTER TRIGGER AKTIVNOSTI_IME_PREDAVACA_UPDATE DISABLE';
    UPDATE AKTIVNOSTI
    SET ime_predavaca = :NEW.ime
    WHERE id_predavaca = :NEW.id_predavaca;
    EXECUTE IMMEDIATE 'ALTER TRIGGER AKTIVNOSTI_INSERT_UPDATE ENABLE';
    EXECUTE IMMEDIATE 'ALTER TRIGGER AKTIVNOSTI_IME_PREDAVACA_UPDATE ENABLE';
END;

ALTER TABLE ZAUZETOSTI
ADD vreme_do NUMBER(2);

UPDATE ZAUZETOSTI
SET vreme_do = vreme_od + (
    SELECT trajanje
    FROM AKTIVNOSTI
    WHERE id_aktivnosti = aktivnost
)

ALTER TABLE ZAUZETOSTI
MODIFY vreme_do NUMBER(2) NOT NULL;

CREATE OR REPLACE TRIGGER zauzetosti_racunanje_vreme_do
BEFORE INSERT OR UPDATE OF vreme_od ON ZAUZETOSTI
FOR EACH ROW
DECLARE
    t NUMBER(1);
BEGIN
    SELECT trajanje
    INTO t
    FROM AKTIVNOSTI
    WHERE id_aktivnosti = :NEW.aktivnost;

    :NEW.vreme_do := :NEW.vreme_od + t;
END;

CREATE OR REPLACE TRIGGER zauzetosti_vreme_do_direktno
BEFORE UPDATE OF vreme_do ON ZAUZETOSTI
FOR EACH ROW
BEGIN
    RAISE_APPLICATION_ERROR(
        NUM=>-20002,
        MSG=>'Zabranjeno je direktno ažurirati kolonu vreme_do!'
    );
END;

CREATE OR REPLACE FUNCTION BrojAktivnostiUcionice(
    p_ucionica_id IN NUMBER,
    p_datum IN DATE
) RETURN NUMBER IS
    v_broj NUMBER := 0;
BEGIN
    SELECT COUNT(*)
    INTO v_broj
    FROM ZAUZETOSTI
    WHERE BR_UC = p_ucionica_id
    AND TRUNC(DATUM) = TRUNC(p_datum);

    RETURN v_broj;
EXCEPTION
    WHEN NO_DATA_FOUND THEN
        RETURN 0;
END BrojAktivnostiUcionice;

CREATE OR REPLACE PROCEDURE InformacijeOAktivnosti (
    p_ucionica_id IN NUMBER,
    p_datum IN DATE,
    p_vreme_od IN NUMBER
) IS
    v_naziv_aktivnosti VARCHAR2(60);
    v_tip_aktivnosti VARCHAR2(60);
    v_predmet VARCHAR2(50);
    v_obavezna VARCHAR2(2);
BEGIN
    SELECT a.naziv, a.tip_aktivnosti, p.naziv_predmeta, DECODE(a.redovna, 1, 'DA', 'NE')
    INTO v_naziv_aktivnosti, v_tip_aktivnosti, v_predmet, v_obavezna
    FROM ZAUZETOSTI z
    JOIN AKTIVNOSTI a ON z.aktivnost = a.id_aktivnosti
    JOIN PREDMETI p ON a.id_predmeta = p.id_predmeta
    WHERE z.br_uc = p_ucionica_id
      AND z.datum = p_datum
      AND z.vreme_od = p_vreme_od;

    DBMS_OUTPUT.PUT_LINE('Naziv aktivnosti: ' || v_naziv_aktivnosti);
    DBMS_OUTPUT.PUT_LINE('Tip aktivnosti: ' || v_tip_aktivnosti);
    DBMS_OUTPUT.PUT_LINE('Predmet: ' || v_predmet);
    DBMS_OUTPUT.PUT_LINE('Da li je obavezna: ' || v_obavezna);
EXCEPTION
    WHEN NO_DATA_FOUND THEN
        DBMS_OUTPUT.PUT_LINE('Nema aktivnosti za zadate parametre.');
    WHEN OTHERS THEN
        DBMS_OUTPUT.PUT_LINE('Došlo je do greške: ' || SQLERRM);
END InformacijeOAktivnosti;


